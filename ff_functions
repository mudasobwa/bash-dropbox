#!/bin/bash

# load default configuration
source /etc/forkforge.conf
# load user-specific config
source $HOME_DIR/.forkforgerc

# log the message/error 
ff_log() { 
  if [ x"$LOG_LEVEL" == x"ALL" ]; then 
    logger -f $LOG_FILE -s "[LOG] $1"; 
  fi
}
ff_info() {
  logger -f $LOG_FILE "[INFO] $1"
}
ff_err() {
  logger -f $LOG_FILE "[ERR] $1"
}

# mount/unmount remote filesystem
ff_ssh_mount() {
  sshfs $REMOTE_HOST_USER@$REMOTE_HOST:$REMOTE_HOST_DIR $REMOTE_DIR 2>/dev/null
}
ff_ssh_umount() {
  fusermount -u $REMOTE_DIR
}
ff_is_mounted() {
  mount | grep $REMOTE_HOST_DIR
}

# init reconnections of remote
ff_install() {
  cat << EOF > $IFACE_UP_DIR/$QUEUE-$FF_NAME
[ "$IFACE" != "lo" ] || exit 0
sshfs $REMOTE_HOST_USER@$REMOTE_HOST:$REMOTE_HOST_DIR $REMOTE_DIR 2>/dev/null && \
ff_total_sync && \
service incron start
EOF
  cat << EOF > $IFACE_DOWN_DIR/$QUEUE-$FF_NAME
[ "$IFACE" != "lo" ] || exit 0
service incron stop && fusermount -u $REMOTE_DIR
EOF
  mkdir -p $IFACE_UP_DIR_SURROGATE && \
    pushd $IFACE_UP_DIR_SURROGATE && \
    ln -s $IFACE_UP_DIR/$QUEUE-$FF_NAME && \
    popd
}
ff_uninstall() {
  rm -rf $IFACE_UP_DIR/$QUEUE-$FF_NAME
  rm -rf $IFACE_DOWN_DIR/$QUEUE-$FF_NAME
  rm -rf $IFACE_UP_DIR_SURROGATE/$QUEUE-$FF_NAME
}
